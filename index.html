<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
      #messages { margin-bottom: 40px }
      .tabcontent {
        alignment: center;
        margin-left: 350px;
      }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <div>
    <video controls="" id="_video123" autoplay="autoplay"></video>
    <video controls="" id="_video345" autoplay="autoplay"></video>
    <video controls="" id="_video567" autoplay="autoplay"></video>
    <video controls="" id="_video789" autoplay="autoplay"></video>
    <video controls="" id="_video001" autoplay="autoplay"></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
      $(function () {
        //const socket = io('https://192.168.1.3:5000?user=abc');
        const socket = io('https://192.168.1.3:3050?'+window.location.search.substr(1));
        var myId = '';
        $('form').submit(function(){
          socket.emit('chat message', $('#m').val());
          $('#m').val('');
          return false;
        });
        socket.on('chat message', function(msg){
          $('#messages').append($('<li>').text(msg));
          window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('whoami', function (msg) {
          myId = msg.toString();
         // alert(myId);
        })

        var constraints = {
          audio: true,
          video: { width: 200, height: 200 }
        };

        navigator.mediaDevices.getUserMedia(constraints).then(function(mediaStream) {

          switch(myId) {
            case "123":
              document.getElementById("_video123").srcObject = mediaStream;
              break;
            case "345":
              document.getElementById("_video345").srcObject = mediaStream;
              break;
            case "567":
              document.getElementById("_video567").srcObject = mediaStream;
              break;
            case "789":
              document.getElementById("_video789").srcObject = mediaStream;
              break;
            case "001":
              document.getElementById("_video001").srcObject = mediaStream;
              break;
            default:
          }
          var mediaRecorder = new MediaRecorder(mediaStream);
          mediaRecorder.onstart = function(e) {
            this.chunks = [];

          };
          mediaRecorder.ondataavailable = function(e) {
            this.chunks.push(e.data);
          };
          mediaRecorder.onstop = function(e) {
            var blob = new Blob(this.chunks, { type: 'video/webm'  });
            socket.emit('radio', blob);
          };

          // Start recording
          mediaRecorder.start();

          // Stop recording after 5 seconds and broadcast it to server
          setInterval(function() {
            mediaRecorder.stop();
            mediaRecorder.start();
          }, 500);


        });

        const arrayOfBlobs123 = [];
        const arrayOfBlobs345 = [];
        const arrayOfBlobs567 = [];
        const arrayOfBlobs789 = [];
        const arrayOfBlobs001 = [];

        // 1. Create a `MediaSource`
        const mediaSource123 = new MediaSource();
        const mediaSource345 = new MediaSource();
        const mediaSource567 = new MediaSource();
        const mediaSource789 = new MediaSource();
        const mediaSource001 = new MediaSource();


        // 2. Create an object URL from the `MediaSource`
        const url123 = URL.createObjectURL(mediaSource123);
        const url345 = URL.createObjectURL(mediaSource345);
        const url567 = URL.createObjectURL(mediaSource567);
        const url789 = URL.createObjectURL(mediaSource789);
        const url001 = URL.createObjectURL(mediaSource001);

        // 3. Set the video's `src` to the object URL
        const video123 = document.getElementById("_video123");
        video123.src = url123;

        /*video123.addEventListener('loadedmetadata', function() {
          if (video123.buffered.length === 0) {
         //   appendToSourceBuffer123();
            return ;
          };

          var bufferedSeconds = video123.buffered.end(0) - video123.buffered.start(0);
          //alert(bufferedSeconds + ' seconds of video are ready to play!');
        });*/

        const video345 = document.getElementById("_video345");
        video345.src = url345;

       /* video345.addEventListener('loadedmetadata', function() {
          if (video345.buffered.length === 0) {
         //   appendToSourceBuffer345();
            return;
          };

          var bufferedSeconds = video345.buffered.end(0) - video345.buffered.start(0);
          //alert(bufferedSeconds + ' seconds of video are ready to play!');
        });*/

        const video567 = document.getElementById("_video567");
        video567.src = url567;

        const video789 = document.getElementById("_video789");
        video789.src = url789;

        const video001 = document.getElementById("_video001");
        video001.src = url001;

        // When the client receives a voice message it will play the sound
        socket.on('voice123', function(arrayBuffer) {
          // let video = document.getElementById('_video123');
          //  video.pause();
        //  var blob = new Blob([arrayBuffer], {  type: 'video/webm'  });
          // var audio = document.createElement('audio');
          //  audio.src = window.URL.createObjectURL(blob);
          //  audio.play();
          //video.setAttribute('src', URL.createObjectURL(blob));
          // video.load();
          // video.play();
          //alert(arrayBuffer.byteLength);
          arrayOfBlobs123.push(arrayBuffer);
         // arrayOfBlobs123.push(URL.createObjectURL(blob));
          appendToSourceBuffer123();

        });

        socket.on('voice345', function(arrayBuffer) {
          // let video = document.getElementById('_video345');
          // video.pause();
          //var blob = new Blob([arrayBuffer], {  type: 'video/webm' });
          // var audio = document.createElement('audio');
          //  audio.src = window.URL.createObjectURL(blob);
          //  audio.play();
          // video.setAttribute('src', URL.createObjectURL(blob));
          //  video.load();
          // video.play();

          //arrayOfBlobs345.push(URL.createObjectURL(blob));
          //alert('got something..345 ',arrayBuffer.size);
          arrayOfBlobs345.push(arrayBuffer);
          appendToSourceBuffer345();
        });

        socket.on('voice567', function(arrayBuffer) {
          // let video = document.getElementById('_video567');
          // video.pause();
          var blob = new Blob([arrayBuffer], {  type: 'video/webm' });
          // var audio = document.createElement('audio');
          //  audio.src = window.URL.createObjectURL(blob);
          //  audio.play();
          //  video.setAttribute('src', URL.createObjectURL(blob));
          //  video.load();
          //  video.play();

         // arrayOfBlobs567.push(URL.createObjectURL(blob));
          arrayOfBlobs567.push(arrayBuffer);
          appendToSourceBuffer567();
        });

        socket.on('voice789', function(arrayBuffer) {
          // let video = document.getElementById('_video567');
          // video.pause();
          var blob = new Blob([arrayBuffer], {  type: 'video/webm' });
          // var audio = document.createElement('audio');
          //  audio.src = window.URL.createObjectURL(blob);
          //  audio.play();
          //  video.setAttribute('src', URL.createObjectURL(blob));
          //  video.load();
          //  video.play();

          // arrayOfBlobs567.push(URL.createObjectURL(blob));
          arrayOfBlobs789.push(arrayBuffer);
          appendToSourceBuffer789();
        });

        socket.on('voice001', function(arrayBuffer) {
          // let video = document.getElementById('_video567');
          // video.pause();
          var blob = new Blob([arrayBuffer], {  type: 'video/webm' });
          // var audio = document.createElement('audio');
          //  audio.src = window.URL.createObjectURL(blob);
          //  audio.play();
          //  video.setAttribute('src', URL.createObjectURL(blob));
          //  video.load();
          //  video.play();

          // arrayOfBlobs567.push(URL.createObjectURL(blob));
          arrayOfBlobs001.push(arrayBuffer);
          appendToSourceBuffer001();
        });


        // 4. On the `sourceopen` event, create a `SourceBuffer`
        var sourceBuffer123 = null;
        mediaSource123.addEventListener("sourceopen", function()
        {

          // NOTE: Browsers are VERY picky about the codec being EXACTLY
          // right here. Make sure you know which codecs you're using!
          sourceBuffer123 = mediaSource123.addSourceBuffer("video/webm; codecs=\"opus,vp8\"");


          // If we requested any video data prior to setting up the SourceBuffer,
          // we want to make sure we only append one blob at a time
          sourceBuffer123.addEventListener("playing", appendToSourceBuffer123);

        });

        var sourceBuffer345 = null;
        mediaSource345.addEventListener("sourceopen", function()
        {
          // NOTE: Browsers are VERY picky about the codec being EXACTLY
          // right here. Make sure you know which codecs you're using!
          sourceBuffer345 = mediaSource345.addSourceBuffer("video/webm; codecs=\"opus,vp8\"");

          // If we requested any video data prior to setting up the SourceBuffer,
          // we want to make sure we only append one blob at a time
          sourceBuffer345.addEventListener("playing", appendToSourceBuffer345);
        });

        var sourceBuffer567 = null;
        mediaSource567.addEventListener("sourceopen", function()
        {
          // NOTE: Browsers are VERY picky about the codec being EXACTLY
          // right here. Make sure you know which codecs you're using!
          sourceBuffer567 = mediaSource567.addSourceBuffer("video/webm; codecs=\"opus,vp8\"");

          // If we requested any video data prior to setting up the SourceBuffer,
          // we want to make sure we only append one blob at a time
          sourceBuffer567.addEventListener("playing", appendToSourceBuffer567);
        });

        var sourceBuffer789 = null;
        mediaSource789.addEventListener("sourceopen", function()
        {
          // NOTE: Browsers are VERY picky about the codec being EXACTLY
          // right here. Make sure you know which codecs you're using!
          sourceBuffer789 = mediaSource789.addSourceBuffer("video/webm; codecs=\"opus,vp8\"");

          // If we requested any video data prior to setting up the SourceBuffer,
          // we want to make sure we only append one blob at a time
          sourceBuffer789.addEventListener("playing", appendToSourceBuffer789);
        });

        var sourceBuffer001 = null;
        mediaSource001.addEventListener("sourceopen", function()
        {
          // NOTE: Browsers are VERY picky about the codec being EXACTLY
          // right here. Make sure you know which codecs you're using!
          sourceBuffer001 = mediaSource001.addSourceBuffer("video/webm; codecs=\"opus,vp8\"");

          // If we requested any video data prior to setting up the SourceBuffer,
          // we want to make sure we only append one blob at a time
          sourceBuffer001.addEventListener("playing", appendToSourceBuffer001);
        });

        function appendToSourceBuffer123() {
          //alert("gtiiti----");
          if (
                  mediaSource123.readyState === "open" &&
                  sourceBuffer123 &&
                  sourceBuffer123.updating === false
          ) {
            //  alert("gtiiti");

            if(arrayOfBlobs123.length) {
              let data = arrayOfBlobs123.shift();
             // alert("success123");
              sourceBuffer123.appendBuffer(data);
              if(video123.buffered.length &&
                      video123.buffered.end(0) - video123.buffered.start(0) < 5) {
                video123.currentTime = 0.01;
              }
              //video123.play();

            }
          }

          // Limit the total buffer size to 20 minutes
          // This way we don't run out of RAM
          if (
                  video123.buffered.length &&
                  video123.buffered.end(0) - video123.buffered.start(0) > 1200
          ) {
            sourceBuffer123.remove(0, video123.buffered.end(0) - 1200)
          }
        }

        function appendToSourceBuffer345() {
          if (
                  mediaSource345.readyState === "open" &&
                  sourceBuffer345 &&
                  sourceBuffer345.updating === false
          ) {

            if(arrayOfBlobs345.length) {
              let data = arrayOfBlobs345.shift();
              //alert("success345");
              sourceBuffer345.appendBuffer(data);
              if(video345.buffered.end(0) - video345.buffered.start(0) < 5) {
                video345.currentTime = 0.01;
              }
          //    video345.currentTime = 0.01;
            //  video1345.play();

            }
            // sourceBuffer345.appendBuffer(arrayOfBlobs345.shift());
          }

          // Limit the total buffer size to 20 minutes
          // This way we don't run out of RAM
          if (
                  video345.buffered.length &&
                  video345.buffered.end(0) - video345.buffered.start(0) > 1200
          ) {
            sourceBuffer345.remove(0, video345.buffered.end(0) - 1200)
          }
        }

        function appendToSourceBuffer567()
        {
          if (
                  mediaSource567.readyState === "open" &&
                  sourceBuffer567 &&
                  sourceBuffer567.updating === false
          )
          {
            let data = arrayOfBlobs567.shift();
            //alert("success345");
            sourceBuffer567.appendBuffer(data);
            if(video567.buffered.end(0) - video567.buffered.start(0) < 10) {
              video567.currentTime = 0.01;
            }
          }

          // Limit the total buffer size to 20 minutes
          // This way we don't run out of RAM
          if (
                  video567.buffered.length &&
                  video567.buffered.end(0) - video567.buffered.start(0) > 1200
          )
          {
            sourceBuffer567.remove(0, video567.buffered.end(0) - 1200)
          }
        }

        function appendToSourceBuffer789()
        {
          if (
                  mediaSource789.readyState === "open" &&
                  sourceBuffer789 &&
                  sourceBuffer789.updating === false
          )
          {
            let data = arrayOfBlobs789.shift();
            //alert("success345");
            sourceBuffer789.appendBuffer(data);
            if(video789.buffered.end(0) - video789.buffered.start(0) < 10) {
              video789.currentTime = 0.01;
            }
          }

          // Limit the total buffer size to 20 minutes
          // This way we don't run out of RAM
          if (
                  video789.buffered.length &&
                  video789.buffered.end(0) - video789.buffered.start(0) > 1200
          )
          {
            sourceBuffer789.remove(0, video789.buffered.end(0) - 1200)
          }
        }


        function appendToSourceBuffer001()
        {
          if (
                  mediaSource001.readyState === "open" &&
                  sourceBuffer001 &&
                  sourceBuffer001.updating === false
          )
          {
            let data = arrayOfBlobs001.shift();
            //alert("success345");
            sourceBuffer001.appendBuffer(data);
            if(video001.buffered.end(0) - video001.buffered.start(0) < 10) {
              video001.currentTime = 0.01;
            }
          }

          // Limit the total buffer size to 20 minutes
          // This way we don't run out of RAM
          if (
                  video001.buffered.length &&
                  video001.buffered.end(0) - video001.buffered.start(0) > 1200
          )
          {
            sourceBuffer001.remove(0, video001.buffered.end(0) - 1200)
          }
        }



      });
    </script>
  </body>
</html>
